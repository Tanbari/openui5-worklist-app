/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataBinding","./lib/_Helper","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/thirdparty/jquery"],function(e,t,r,n,i,o){"use strict";function a(){e.call(this);this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.aChildCanUseCachePromises=[];this.iPatchCounter=0;this.bPatchSuccess=true}e(a.prototype);var s="sap.ui.model.odata.v4.ODataParentBinding";a.prototype.attachPatchCompleted=function(e,t){this.attachEvent("patchCompleted",e,t)};a.prototype.detachPatchCompleted=function(e,t){this.detachEvent("patchCompleted",e,t)};a.prototype.firePatchCompleted=function(e){if(this.iPatchCounter===0){throw new Error("Completed more PATCH requests than sent")}this.iPatchCounter-=1;this.bPatchSuccess=this.bPatchSuccess&&e;if(this.iPatchCounter===0){this.fireEvent("patchCompleted",{success:this.bPatchSuccess});this.bPatchSuccess=true}};a.prototype.attachPatchSent=function(e,t){this.attachEvent("patchSent",e,t)};a.prototype.detachPatchSent=function(e,t){this.detachEvent("patchSent",e,t)};a.prototype.firePatchSent=function(){this.iPatchCounter+=1;if(this.iPatchCounter===1){this.fireEvent("patchSent")}};a.prototype.addToSelect=function(e,t){e.$select=e.$select||[];t.forEach(function(t){if(e.$select.indexOf(t)<0){e.$select.push(t)}})};a.prototype.aggregateQueryOptions=function(e,t){var r=o.extend(true,{},this.mAggregatedQueryOptions);function n(e,r,i){var o,a;function s(i){if(e.$expand[i]){return n(e.$expand[i],r.$expand[i],true)}if(t){return false}e.$expand[i]=o[i];return true}function u(r){if(e.$select.indexOf(r)<0){if(t){return false}e.$select.push(r)}return true}o=r.$expand;if(o){e.$expand=e.$expand||{};if(!Object.keys(o).every(s)){return false}}a=r.$select;if(a){e.$select=e.$select||[];if(!a.every(u)){return false}}if(r.$count){e.$count=true}return Object.keys(r).concat(Object.keys(e)).every(function(t){if(t==="$count"||t==="$expand"||t==="$select"||!i&&!(t in r)){return true}return r[t]===e[t]})}if(n(r,e)){this.mAggregatedQueryOptions=r;return true}return false};a.prototype.changeParameters=function(e){var t=o.extend(true,{},this.mParameters),r,n,a=this;function s(t){if(a.oModel.bAutoExpandSelect&&t in e){throw new Error("Cannot change $expand or $select parameter in "+"auto-$expand/$select mode: "+t+"="+JSON.stringify(e[t]))}}function u(e){if(e==="$filter"||e==="$search"){r=i.Filter}else if(e==="$orderby"&&r!==i.Filter){r=i.Sort}else if(!r){r=i.Change}}this.checkSuspended();if(!e){throw new Error("Missing map of binding parameters")}s("$expand");s("$select");if(this.hasPendingChanges()){throw new Error("Cannot change parameters due to pending changes")}for(n in e){if(n.indexOf("$$")===0){throw new Error("Unsupported parameter: "+n)}if(e[n]===undefined&&t[n]!==undefined){u(n);delete t[n]}else if(t[n]!==e[n]){u(n);if(typeof e[n]==="object"){t[n]=o.extend(true,{},e[n])}else{t[n]=e[n]}}}if(r){this.applyParameters(t,r)}};a.prototype.checkUpdate=function(){var e=this;function t(){return n.all(e.getDependentBindings().map(function(e){return e.checkUpdate()}))}if(arguments.length>0){throw new Error("Unsupported operation: "+s+"#checkUpdate must not be"+" called with parameters")}return this.oCachePromise.then(function(r){if(r&&e.bRelative){return e.fetchResourcePath(e.oContext).then(function(n){if(r.$resourcePath===n){return t()}return e.refreshInternal()}).catch(function(t){e.oModel.reportError("Failed to update "+e,s,t)})}return t()})};a.prototype.createInCache=function(e,r,n,i,o){var a=this;return this.oCachePromise.then(function(s){if(s){return s.create(e,r,n,i,o,function(e){a.oModel.reportError("POST on '"+r+"' failed; will be repeated automatically","sap.ui.model.odata.v4.ODataParentBinding",e)}).then(function(e){if(s.$resourcePath){delete a.mCacheByResourcePath[s.$resourcePath]}return e})}return a.oContext.getBinding().createInCache(e,r,t.buildPath(a.oContext.iIndex,a.sPath,n),i,o)})};a.prototype.createReadGroupLock=function(e,t,n){var i,o=this;function a(){sap.ui.getCore().addPrerenderingTask(function(){n-=1;if(n>0){Promise.resolve().then(a)}else if(o.oReadGroupLock===i){r.debug("Timeout: unlocked "+i,null,s);i.unlock(true);o.oReadGroupLock=undefined}})}this.removeReadGroupLock();this.oReadGroupLock=i=this.lockGroup(e,t);if(t){n=2+(n||0);a()}};a.prototype.destroy=function(){this.aChildCanUseCachePromises=[]};a.prototype.deleteFromCache=function(e,r,n,i){var o=this.oCachePromise.getResult(),a;if(!this.oCachePromise.isFulfilled()){throw new Error("DELETE request not allowed")}if(o){e.setGroupId(this.getUpdateGroupId());a=e.getGroupId();if(!this.oModel.isAutoGroup(a)&&!this.oModel.isDirectGroup(a)){throw new Error("Illegal update group ID: "+a)}return o._delete(e,r,n,i)}return this.oContext.getBinding().deleteFromCache(e,r,t.buildPath(this.oContext.iIndex,this.sPath,n),i)};a.prototype.fetchIfChildCanUseCache=function(e,i,a){var u,h,d,c,p,f,l=this.oModel.getMetaModel(),g,y=this;function P(){if(f){return l.fetchObject(p.slice(0,p.lastIndexOf("/")+1))}return l.fetchObject(p).then(function(e){if(e&&e.$kind==="NavigationProperty"){return l.fetchObject(p+"/").then(function(){return e})}return e})}if(this.oOperation||i==="$count"||i.slice(-7)==="/$count"||i[0]==="@"||this.getRootBinding().isSuspended()){return n.resolve(true)}h=this.oCachePromise.isRejected()||this.oCachePromise.isFulfilled()&&!this.oCachePromise.getResult()||this.oCachePromise.isFulfilled()&&this.oCachePromise.getResult().bSentReadRequest;u=l.getMetaPath(e.getPath());c=l.getMetaPath("/"+i).slice(1);f=c[0]==="#";p=t.buildPath(u,c);g=[this.doFetchQueryOptions(this.oContext),P(),a];d=n.all(g).then(function(e){var t=e[2],n,i=e[0],a=e[1];if(y.bAggregatedQueryOptionsInitial){y.selectKeyProperties(i,u);y.mAggregatedQueryOptions=o.extend(true,{},i);y.bAggregatedQueryOptionsInitial=false}if(f){n={$select:[c.slice(1)]};return y.aggregateQueryOptions(n,h)}if(c===""||a&&(a.$kind==="Property"||a.$kind==="NavigationProperty")){n=y.wrapChildQueryOptions(u,c,t);if(n){return y.aggregateQueryOptions(n,h)}return false}if(c==="value"){return y.aggregateQueryOptions(t,h)}r.error("Failed to enhance query options for auto-$expand/$select as the path '"+p+"' does not point to a property",JSON.stringify(a),"sap.ui.model.odata.v4.ODataParentBinding");return false});this.aChildCanUseCachePromises.push(d);this.oCachePromise=n.all([this.oCachePromise,d]).then(function(e){var t=e[0];if(t&&!t.bSentReadRequest){t.setQueryOptions(o.extend(true,{},y.oModel.mUriParameters,y.mAggregatedQueryOptions))}return t}).catch(function(e){y.oModel.reportError("Failed to update cache for binding "+y,s,e)});return d};a.prototype.getQueryOptionsForPath=function(e,r){var n;if(Object.keys(this.mParameters).length){n=this.mQueryOptions;this.oModel.getMetaModel().getMetaPath("/"+e).slice(1).split("/").some(function(e){n=n.$expand&&n.$expand[e];if(!n||n===true){n={};return true}});return o.extend(true,{},n)}r=r||this.oContext;if(!this.bRelative||!r.getQueryOptionsForPath){return{}}return r.getQueryOptionsForPath(t.buildPath(this.sPath,e))};a.prototype.initialize=function(){if((!this.bRelative||this.oContext)&&!this.getRootBinding().isSuspended()){this._fireChange({reason:i.Change})}};a.prototype.isPatchWithoutSideEffects=function(){return!!this.mParameters.$$patchWithoutSideEffects};a.prototype.refreshDependentBindings=function(e,t){return n.all(this.getDependentBindings().map(function(r){return r.refreshInternal(e,t)}))};a.prototype.removeReadGroupLock=function(){if(this.oReadGroupLock){this.oReadGroupLock.unlock(true);this.oReadGroupLock=undefined}};a.prototype.resume=function(){var e=this;if(this.oOperation){throw new Error("Cannot resume an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot resume a relative binding: "+this)}if(!this.bSuspended){throw new Error("Cannot resume a not suspended binding: "+this)}this.bSuspended=false;this.createReadGroupLock(this.getGroupId(),true,1);sap.ui.getCore().addPrerenderingTask(function(){e.resumeInternal(true)})};a.prototype.selectKeyProperties=function(e,t){var r=this.oModel.getMetaModel().getObject(t+"/");if(r&&r.$Key){this.addToSelect(e,r.$Key.map(function(e){if(typeof e==="object"){return e[Object.keys(e)[0]]}return e}))}};a.prototype.suspend=function(){if(this.oOperation){throw new Error("Cannot suspend an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot suspend a relative binding: "+this)}if(this.bSuspended){throw new Error("Cannot suspend a suspended binding: "+this)}if(this.hasPendingChanges()){throw new Error("Cannot suspend a binding with pending changes: "+this)}this.bSuspended=true;if(this.oReadGroupLock){this.oReadGroupLock.unlock(true);this.oReadGroupLock=undefined}};a.prototype.updateAggregatedQueryOptions=function(e){var t=Object.keys(e),r=this;if(this.mAggregatedQueryOptions){t=t.concat(Object.keys(this.mAggregatedQueryOptions));t.forEach(function(t){if(t==="$select"||t==="$expand"){return}if(e[t]===undefined){delete r.mAggregatedQueryOptions[t]}else{r.mAggregatedQueryOptions[t]=e[t]}})}};a.prototype.wrapChildQueryOptions=function(e,n,i){var o="",a,s=n.split("/"),u,h=e,d={},c=d;if(n===""){return i}for(a=0;a<s.length;a+=1){h=t.buildPath(h,s[a]);o=t.buildPath(o,s[a]);u=this.oModel.getMetaModel().getObject(h);if(u.$kind==="NavigationProperty"){c.$expand={};c=c.$expand[o]=a===s.length-1?i:{};this.selectKeyProperties(c,h);o=""}else if(u.$kind!=="Property"){return undefined}}if(u.$kind==="Property"){if(Object.keys(i).length>0){r.error("Failed to enhance query options for "+"auto-$expand/$select as the child binding has query options, "+"but its path '"+n+"' points to a structural "+"property",JSON.stringify(i),"sap.ui.model.odata.v4.ODataParentBinding");return undefined}this.addToSelect(c,[o])}if("$apply"in i){r.debug("Cannot wrap $apply into $expand: "+n,JSON.stringify(i),"sap.ui.model.odata.v4.ODataParentBinding");return undefined}return d};function u(e){if(this){a.apply(this,arguments)}else{o.extend(e,a.prototype)}}u.prototype.destroy=a.prototype.destroy;return u},false);