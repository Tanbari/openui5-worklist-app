/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Context","./ODataParentBinding","./lib/_Cache","./lib/_GroupLock","./lib/_Helper","sap/ui/base/SyncPromise","sap/ui/model/Binding","sap/ui/model/ChangeReason","sap/ui/model/ContextBinding","sap/ui/thirdparty/jquery"],function(e,t,o,n,r,i,s,a,h,u){"use strict";var d="sap.ui.model.odata.v4.ODataContextBinding",l={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true,patchCompleted:true,patchSent:true};function c(e,t){return e.slice(0,e.indexOf("("))+t}var p=h.extend("sap.ui.model.odata.v4.ODataContextBinding",{constructor:function(o,n,r,s){var a=n.indexOf("(...)");h.call(this,o,n);t.call(this);if(n.slice(-1)==="/"){throw new Error("Invalid path: "+n)}this.oCachePromise=i.resolve();this.sGroupId=undefined;this.bInheritExpandSelect=false;this.oOperation=undefined;this.oReadGroupLock=undefined;this.oReturnValueContext=null;this.sUpdateGroupId=undefined;if(a>=0){this.oOperation={bAction:undefined,mParameters:{},sResourcePath:undefined};if(a!==this.sPath.length-5){throw new Error("The path must not continue after a deferred operation: "+this.sPath)}}this.applyParameters(u.extend(true,{},s));this.oElementContext=this.bRelative?null:e.create(this.oModel,this,n);if(!this.oOperation&&(!this.bRelative||r&&!r.fetchValue)){this.createReadGroupLock(this.getGroupId(),true)}this.setContext(r);o.bindingCreated(this)},metadata:{publicMethods:[]}});t(p.prototype);p.prototype._delete=function(e,t){var o=this;if(this.sPath===""&&this.oContext.delete){return this.oContext._delete(e)}if(this.hasPendingChanges()){throw new Error("Cannot delete due to pending changes")}return this.deleteFromCache(e,t,"",function(){o.oElementContext.destroy();o.oElementContext=null;if(o.oReturnValueContext){o.oReturnValueContext.destroy();o.oReturnValueContext=null}o._fireChange({reason:a.Remove})})};p.prototype._execute=function(t){var o=this.oModel.getMetaModel(),n,i,s=this.getResolvedPath(),h=this;function u(){h._fireChange({reason:a.Change});return h.refreshDependentBindings(t.getGroupId(),true)}t.setGroupId(this.getGroupId());i=o.fetchObject(o.getMetaPath(s)+"/@$ui5.overload").then(function(e){var o,r,i;if(!e){throw new Error("Unknown operation: "+s)}if(e.length!==1){throw new Error("Unsupported overloads for "+s)}if(h.bRelative&&h.oContext.getBinding){r=h.sPath.lastIndexOf("/");i=r>=0?h.sPath.slice(0,r):"";o=h.oContext.getValue.bind(h.oContext,i)}n=e[0];return h.createCacheAndRequest(t,s,n,o)}).then(function(t){var o,i;return u().then(function(){if(h.hasReturnValueContext(n)){o=r.getPrivateAnnotation(h.oContext.fetchValue().getResult(),"predicate");i=r.getPrivateAnnotation(t,"predicate");if(o===i){h.oContext.patch(t)}if(h.oReturnValueContext){h.oReturnValueContext.destroy()}h.oReturnValueContext=e.create(h.oModel,h,c(s,i));return h.oReturnValueContext}})},function(e){var t;function o(e){if(e.target){var o=e.target.split("/");if(o.shift()===t){e.target=o.join("/");return}}delete e.target}if(n&&n.$IsBound){t=n.$Parameter[0].$Name;e.resourcePath=h.oContext.getPath().slice(1);if(e.error){o(e.error);if(e.error.details){e.error.details.forEach(o)}}}return u().then(function(){throw e})}).catch(function(e){t.unlock(true);if(h.oReturnValueContext){h.oReturnValueContext.destroy();h.oReturnValueContext=null}h.oModel.reportError("Failed to execute "+s,d,e);throw e});return Promise.resolve(i)};p.prototype.applyParameters=function(e,t){this.checkBindingParameters(e,["$$canonicalPath","$$groupId","$$inheritExpandSelect","$$ownRequest","$$patchWithoutSideEffects","$$updateGroupId"]);this.sGroupId=e.$$groupId;this.sUpdateGroupId=e.$$updateGroupId;this.bInheritExpandSelect=e.$$inheritExpandSelect;this.mQueryOptions=this.oModel.buildQueryOptions(e,true);this.mParameters=e;if(!this.oOperation){this.fetchCache(this.oContext);if(t){this.refreshInternal(undefined,true)}else{this.checkUpdate()}}else if(this.oOperation.bAction===false){this.execute()}};p.prototype.attachEvent=function(e){if(!(e in l)){throw new Error("Unsupported event '"+e+"': v4.ODataContextBinding#attachEvent")}return h.prototype.attachEvent.apply(this,arguments)};p.prototype.computeOperationQueryOptions=function(){var e,t=u.extend({},this.oModel.mUriParameters,this.mQueryOptions);if(this.bInheritExpandSelect){e=this.oContext.getBinding().mCacheQueryOptions;if("$select"in e){t.$select=e.$select}if("$expand"in e){t.$expand=e.$expand}}return t};p.prototype.createCacheAndRequest=function(e,t,n,s){var a=n.$kind==="Action",h,d=s,l=this.oModel,p=l.getMetaModel().getMetaPath(t)+"/@$ui5.overload/0/$ReturnType",f=t.slice(1),C=u.extend({},this.oOperation.mParameters),x=l.oRequestor,g=this;function m(e){if(g.hasReturnValueContext(n)){return c(f,r.getPrivateAnnotation(e,"predicate"))}return f}if(!a&&n.$kind!=="Function"){throw new Error("Not an operation: "+t)}if(this.bInheritExpandSelect&&!this.hasReturnValueContext(n)){throw new Error("Must not set parameter $$inheritExpandSelect on binding which has "+"no return value context")}this.oOperation.bAction=a;if(a&&s){d=s()}this.mCacheQueryOptions=this.computeOperationQueryOptions();t=x.getPathAndAddQueryOptions(t,n,C,this.mCacheQueryOptions,d);h=o.createSingle(x,t,this.mCacheQueryOptions,l.bAutoExpandSelect,m,a,p,n.$ReturnType&&!n.$ReturnType.$Type.startsWith("Edm."));this.oCachePromise=i.resolve(h);return a?h.post(e,C,d):h.fetchValue(e)};p.prototype.destroy=function(){if(this.oElementContext){this.oElementContext.destroy();this.oElementContext=undefined}if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=undefined}this.oModel.bindingDestroyed(this);this.removeReadGroupLock();this.mCacheByResourcePath=undefined;this.oCachePromise=i.resolve();this.mCacheQueryOptions=undefined;this.oContext=undefined;this.oOperation=undefined;this.mParameters=undefined;this.mQueryOptions=undefined;t.prototype.destroy.apply(this);h.prototype.destroy.apply(this)};p.prototype.doCreateCache=function(e,t){return o.createSingle(this.oModel.oRequestor,e,t,this.oModel.bAutoExpandSelect)};p.prototype.doFetchQueryOptions=function(){return i.resolve(this.mQueryOptions)};p.prototype.execute=function(e){var t=this.oModel.resolve(this.sPath,this.oContext);this.checkSuspended();this.oModel.checkGroupId(e);if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath)}if(this.bRelative){if(!t){throw new Error("Unresolved binding: "+this.sPath)}if(this.oContext.isTransient&&this.oContext.isTransient()){throw new Error("Execute for transient context not allowed: "+t)}if(this.oContext.getPath().indexOf("(...)")>=0){throw new Error("Nested deferred operation bindings not supported: "+t)}}return this._execute(this.lockGroup(e,true))};p.prototype.fetchValue=function(e,t,o){var r,i,s=this.getRootBinding(),a=this;if(s&&s.isSuspended()){r=new Error("Suspended binding provides no value");r.canceled="noDebugLog";throw r}return this.oCachePromise.then(function(r){var s=false,h;if(r){h=a.getRelativePath(e);if(h!==undefined){if(o){i=n.$cached}else{i=a.lockGroup(a.getGroupId(),a.oReadGroupLock);a.oReadGroupLock=undefined}return r.fetchValue(i,h,function(){s=true;a.fireDataRequested()},t).then(function(e){if(s){a.fireDataReceived({data:{}})}return e},function(e){i.unlock(true);if(s){a.oModel.reportError("Failed to read path "+a.sPath,d,e);a.fireDataReceived(e.canceled?{data:{}}:{error:e})}throw e})}}if(!a.oOperation&&a.oContext&&a.oContext.fetchValue){return a.oContext.fetchValue(e,t,o)}})};p.prototype.getResolvedPath=function(){var e="",t=this.oModel.resolve(this.sPath,this.oContext),o,n=this;if(t&&t.includes("/-1")){o=t.slice(1).split("/");t="";o.forEach(function(o){var i,s;e+="/"+o;if(o==="-1"){i=n.oContext.fetchValue(e).getResult();s=r.getPrivateAnnotation(i,"predicate");if(!s){throw new Error("No key predicate known at "+e)}t+=s}else{t+="/"+o}})}return t};p.prototype.hasReturnValueContext=function(e){var t=this.oModel.getMetaModel(),o;if(!(this.bRelative&&this.oContext&&this.oContext.getBinding)){return false}o=t.getMetaPath(this.oModel.resolve(this.sPath,this.oContext)).split("/");return e.$IsBound&&e.$ReturnType&&!e.$ReturnType.$isCollection&&e.$EntitySetPath&&e.$EntitySetPath.indexOf("/")<0&&o.length===3&&t.getObject("/"+o[1]).$kind==="EntitySet"};p.prototype.refreshInternal=function(t,o){var n=this;if(this.oOperation&&this.oOperation.bAction!==false){return i.resolve()}this.createReadGroupLock(t,this.isRefreshable());return this.oCachePromise.then(function(r){var i=n.oReadGroupLock;if(!n.oElementContext){n.oElementContext=e.create(n.oModel,n,n.oModel.resolve(n.sPath,n.oContext));if(!r){n._fireChange({reason:a.Refresh})}}if(n.oOperation){n.oReadGroupLock=undefined;return n._execute(i)}if(r){n.removeCachesAndMessages();n.fetchCache(n.oContext)}return n.refreshDependentBindings(t,o)})};p.prototype.refreshReturnValueContext=function(e,t){var n,r=this.oModel;if(this.oReturnValueContext!==e){return null}this.mCacheQueryOptions=this.computeOperationQueryOptions();n=o.createSingle(r.oRequestor,this.oReturnValueContext.getPath().slice(1),this.mCacheQueryOptions,true);this.oCachePromise=i.resolve(n);this.createReadGroupLock(t,true);return this.refreshDependentBindings(t,true)};p.prototype.requestSideEffects=function(e,t,o){var n=this.oCachePromise.getResult(),s,a=this.oModel,h=[];function u(e){h.push(e.catch(function(e){a.reportError("Failed to request side effects",d,e);throw e}))}if(t.indexOf("")<0){try{u(n.requestSideEffects(a.lockGroup(e),t,o&&o.getPath().slice(1)));s=o?a.getDependentBindings(o):this.getDependentBindings();s.forEach(function(o){var n;if(o.oCachePromise.getResult()){n=r.stripPathPrefix(o.getPath(),t);if(n.length){u(o.requestSideEffects(e,n))}}});return i.all(h)}catch(e){if(!e.message.startsWith("Unsupported collection-valued navigation property ")){throw e}}}return o&&this.refreshReturnValueContext(o,e)||this.refreshInternal(e,true)};p.prototype.resumeInternal=function(e){if(!this.oOperation){this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.removeCachesAndMessages();this.fetchCache(this.oContext);this.getDependentBindings().forEach(function(t){t.resumeInternal(e)});this._fireChange({reason:a.Change})}else if(this.oOperation.bAction===false){this.execute()}};p.prototype.setContext=function(t){if(this.oContext!==t){if(this.bRelative&&(this.oContext||t)){if(this.oElementContext){this.oElementContext.destroy();this.oElementContext=null}if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=null}this.fetchCache(t);if(t){this.oElementContext=e.create(this.oModel,this,this.oModel.resolve(this.sPath,t))}s.prototype.setContext.call(this,t)}else{this.oContext=t}}};p.prototype.setParameter=function(e,t){if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath)}if(!e){throw new Error("Missing parameter name")}if(t===undefined){throw new Error("Missing value for parameter: "+e)}this.oOperation.mParameters[e]=t;this.oOperation.bAction=undefined;return this};return p});