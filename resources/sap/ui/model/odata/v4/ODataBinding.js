/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./lib/_Helper","sap/ui/base/SyncPromise","sap/ui/model/odata/OperationMode","sap/ui/model/odata/v4/Context","sap/ui/thirdparty/jquery"],function(e,t,n,r,i){"use strict";var o="sap.ui.model.odata.v4.ODataBinding",s=/\/-?\d/;function a(){}a.prototype.checkBindingParameters=function(e,t){var r=this;Object.keys(e).forEach(function(i){var o=e[i];if(i.indexOf("$$")!==0){return}if(t.indexOf(i)<0){throw new Error("Unsupported binding parameter: "+i)}switch(i){case"$$aggregation":break;case"$$groupId":case"$$updateGroupId":r.oModel.checkGroupId(o,false,"Unsupported value for binding parameter '"+i+"': ");break;case"$$inheritExpandSelect":if(o!==true&&o!==false){throw new Error("Unsupported value for binding parameter "+"'$$inheritExpandSelect': "+o)}if(!r.oOperation){throw new Error("Unsupported binding parameter $$inheritExpandSelect: "+"binding is not an operation binding")}if(e.$expand||e.$select){throw new Error("Must not set parameter $$inheritExpandSelect on a binding "+"which has a $expand or $select binding parameter")}break;case"$$operationMode":if(o!==n.Server){throw new Error("Unsupported operation mode: "+o)}break;case"$$canonicalPath":case"$$ownRequest":case"$$patchWithoutSideEffects":if(o!==true){throw new Error("Unsupported value for binding parameter '"+i+"': "+o)}break;default:throw new Error("Unknown binding-specific parameter: "+i)}})};a.prototype.checkSuspended=function(){var e=this.getRootBinding();if(e&&e.isSuspended()){throw new Error("Must not call method when the binding's root binding is suspended: "+this)}};a.prototype.fetchCache=function(e){var n,s={},a,h,u=this;if(!this.bRelative){e=undefined}if(this.oCachePromise.isFulfilled()){a=this.oCachePromise.getResult();if(a){a.setActive(false)}}h=[this.fetchQueryOptionsForOwnCache(e),this.oModel.oRequestor.ready()];this.mCacheQueryOptions=undefined;n=t.all(h).then(function(t){var o=t[0];if(o&&!(e&&e.getIndex&&e.getIndex()===r.VIRTUAL)){return u.fetchResourcePath(e).then(function(t){var r,a;if(!n||u.oFetchCacheCallToken===s){u.mCacheQueryOptions=i.extend(true,{},u.oModel.mUriParameters,o);if(u.bRelative){u.mCacheByResourcePath=u.mCacheByResourcePath||{};r=u.mCacheByResourcePath[t];if(r){r.setActive(true)}else{r=u.doCreateCache(t,u.mCacheQueryOptions,e);u.mCacheByResourcePath[t]=r;r.$resourcePath=t}}else{r=u.doCreateCache(t,u.mCacheQueryOptions,e)}return r}else{a=new Error("Cache discarded as a new cache has been created");a.canceled=true;throw a}})}});n.catch(function(e){u.oModel.reportError("Failed to create cache for binding "+u,o,e)});this.oCachePromise=n;this.oFetchCacheCallToken=s};a.prototype.fetchQueryOptionsForOwnCache=function(e){var n,r,i=this;if(this.oOperation){return t.resolve(undefined)}if(this.bRelative&&!e){return t.resolve(undefined)}r=this.doFetchQueryOptions(e);if(this.oModel.bAutoExpandSelect&&this.aChildCanUseCachePromises){r=t.all([r,Promise.resolve().then(function(){return t.all(i.aChildCanUseCachePromises)})]).then(function(e){i.aChildCanUseCachePromises=[];i.updateAggregatedQueryOptions(e[0]);return i.mAggregatedQueryOptions})}if(!this.bRelative||!e.fetchValue){return r}if(this.oModel.bAutoExpandSelect){n=this.mParameters&&Object.keys(i.mParameters).some(function(e){return e[0]!=="$"||e[1]==="$"});if(n){return r}return e.getBinding().fetchIfChildCanUseCache(e,i.sPath,r).then(function(e){return e?undefined:r})}if(this.mParameters&&Object.keys(this.mParameters).length){return r}return r.then(function(e){return Object.keys(e).length===0?undefined:e})};a.prototype.fetchResourcePath=function(n){var r,i,o,a=this;if(!this.bRelative){return t.resolve(this.sPath.slice(1))}n=n||this.oContext;if(!n){return t.resolve()}i=n.getPath();r=n.fetchCanonicalPath&&(this.mParameters&&this.mParameters["$$canonicalPath"]||s.test(i));o=r?n.fetchCanonicalPath():t.resolve(i);return o.then(function(t){return e.buildPath(t,a.sPath).slice(1)})};a.prototype.getDependentBindings=function(){return this.oModel.getDependentBindings(this)};a.prototype.getGroupId=function(){return this.sGroupId||this.bRelative&&this.oContext&&this.oContext.getGroupId&&this.oContext.getGroupId()||this.oModel.getGroupId()};a.prototype.getRelativePath=function(e){var t,n;if(e[0]==="/"){n=this.oModel.resolve(this.sPath,this.oContext);if(e.indexOf(n)===0){t=n}else if(this.oReturnValueContext&&e.indexOf(this.oReturnValueContext.getPath())===0){t=this.oReturnValueContext.getPath()}else{return undefined}e=e.slice(t.length);if(e[0]==="/"){e=e.slice(1)}}return e};a.prototype.getRootBinding=function(){if(this.bRelative&&this.oContext&&this.oContext.getBinding){return this.oContext.getBinding().getRootBinding()}return this.bRelative&&!this.oContext?undefined:this};a.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId||this.bRelative&&this.oContext&&this.oContext.getUpdateGroupId&&this.oContext.getUpdateGroupId()||this.oModel.getUpdateGroupId()};a.prototype.hasPendingChanges=function(){return this.hasPendingChangesForPath("")||this.hasPendingChangesInDependents()};a.prototype.hasPendingChangesForPath=function(e){var t=this,n=this.withCache(function(e,t){return e.hasPendingChangesForPath(t)},e).catch(function(e){t.oModel.reportError("Error in hasPendingChangesForPath",o,e);return false});return n.isFulfilled()?n.getResult():false};a.prototype.hasPendingChangesInDependents=function(e){var t=e?this.oModel.getDependentBindings(e):this.getDependentBindings();return t.some(function(e){var t,n;if(e.oCachePromise.isFulfilled()){t=e.oCachePromise.getResult();if(t&&t.hasPendingChangesForPath("")){return true}}if(e.mCacheByResourcePath){n=Object.keys(e.mCacheByResourcePath).some(function(t){return e.mCacheByResourcePath[t].hasPendingChangesForPath("")});if(n){return true}}return e.hasPendingChangesInDependents()})};a.prototype.isInitial=function(){throw new Error("Unsupported operation: isInitial")};a.prototype.isRefreshable=function(){return(!this.bRelative||this.oContext&&!this.oContext.getBinding)&&!this.isSuspended()};a.prototype.lockGroup=function(e,t){return this.oModel.lockGroup(e,t,this)};a.prototype.refresh=function(e){if(!this.isRefreshable()){throw new Error("Refresh on this binding is not supported")}if(this.hasPendingChanges()){throw new Error("Cannot refresh due to pending changes")}this.oModel.checkGroupId(e);this.refreshInternal(e,true)};a.prototype.removeCachesAndMessages=function(){var e=this.oModel,t=e.resolve(this.sPath,this.oContext);if(t){e.reportBoundMessages(t.slice(1),{})}if(this.mCacheByResourcePath){Object.keys(this.mCacheByResourcePath).forEach(function(t){e.reportBoundMessages(t,{})});this.mCacheByResourcePath=undefined}};a.prototype.resetChanges=function(){this.checkSuspended();this.resetChangesForPath("");this.resetChangesInDependents();this.resetInvalidDataState()};a.prototype.resetChangesForPath=function(e){var t=this.withCache(function(e,t){e.resetChangesForPath(t)},e),n=this;t.catch(function(e){n.oModel.reportError("Error in resetChangesForPath",o,e)});if(t.isRejected()){throw t.getResult()}};a.prototype.resetChangesInDependents=function(){this.getDependentBindings().forEach(function(e){var t;if(e.oCachePromise.isFulfilled()){t=e.oCachePromise.getResult();if(t){t.resetChangesForPath("")}e.resetInvalidDataState()}if(e.mCacheByResourcePath){Object.keys(e.mCacheByResourcePath).forEach(function(t){e.mCacheByResourcePath[t].resetChangesForPath("")})}e.resetChangesInDependents()})};a.prototype.resetInvalidDataState=function(){};a.prototype.toString=function(){return this.getMetadata().getName()+": "+(this.bRelative?this.oContext+"|":"")+this.sPath};a.prototype.withCache=function(t,n){var r,i=this;n=n||"";return this.oCachePromise.then(function(o){if(o){r=i.getRelativePath(n);if(r!==undefined){return t(o,r,i)}}else if(i.oOperation){return undefined}if(i.oContext&&i.oContext.withCache){return i.oContext.withCache(t,n[0]==="/"?n:e.buildPath(i.sPath,n))}return undefined})};return function(e){if(e){i.extend(e,a.prototype);return}this.mCacheByResourcePath=undefined}},false);