/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/ui/thirdparty/URI"],function(e,t,n){"use strict";var r=/&/g,i=/\=/g,a=/%29/g,u=/%28/g,f=/%27/g,s=/#/g,o,c=/\([^/]*|\/-?\d+/g,l=/^-?\d+$/,d=/\+/g,p=/'/g;o={addByPath:function(e,t,n){if(n){if(!e[t]){e[t]=[n]}else if(e[t].indexOf(n)<0){e[t].push(n)}}},addChildrenWithAncestor:function(e,t,n){if(t.length){e.forEach(function(e){var r;if(t.indexOf(e)>=0){n[e]=true;return}r=e.split("/");r.pop();while(r.length){if(t.indexOf(r.join("/"))>=0){n[e]=true;break}r.pop()}})}},buildPath:function(){var e,t="",n;for(e=0;e<arguments.length;e++){n=arguments[e];if(n||n===0){if(t&&t!=="/"&&n[0]!=="("){t+="/"}t+=n}}return t},buildQuery:function(e){var t,n;if(!e){return""}t=Object.keys(e);if(t.length===0){return""}n=[];t.forEach(function(t){var r=e[t];if(Array.isArray(r)){r.forEach(function(e){n.push(o.encodePair(t,e))})}else{n.push(o.encodePair(t,r))}});return"?"+n.join("&")},clone:function e(t){return t===undefined||t===Infinity||t===-Infinity||t!==t?t:JSON.parse(JSON.stringify(t))},createError:function(t,n,r){var i=t.responseText,a=t.getResponseHeader("Content-Type"),u=new Error(t.status+" "+t.statusText);u.status=t.status;u.statusText=t.statusText;u.requestUrl=n;u.resourcePath=r;if(t.status===0){u.message="Network error";return u}if(a){a=a.split(";")[0]}if(t.status===412){u.isConcurrentModification=true}if(a==="application/json"){try{u.error=JSON.parse(i).error;u.message=u.error.message;if(typeof u.message==="object"){u.message=u.error.message.value}}catch(t){e.warning(t.toString(),i,"sap.ui.model.odata.v4.lib._Helper")}}else if(a==="text/plain"){u.message=i}return u},createGetMethod:function(e,t){return function(){var n=this[e].apply(this,arguments);if(n.isFulfilled()){return n.getResult()}else if(t){if(n.isRejected()){n.caught();throw n.getResult()}else{throw new Error("Result pending")}}}},createRequestMethod:function(e){return function(){return Promise.resolve(this[e].apply(this,arguments))}},deletePrivateAnnotation:function(e,t){var n=e["@$ui5._"];if(n){delete n[t]}},drillDown:function(e,t){return t.reduce(function(e,t){return e&&t in e?e[t]:undefined},e)},encode:function(e,t){var n=encodeURI(e).replace(r,"%26").replace(s,"%23").replace(d,"%2B");if(t){n=n.replace(i,"%3D")}return n},encodePair:function(e,t){return o.encode(e,true)+"="+o.encode(t,false)},fireChange:function(e,t,n){var r=e[t],i;if(r){for(i=0;i<r.length;i++){r[i].onChange(n)}}},fireChanges:function(e,t,n,r){Object.keys(n).forEach(function(i){var a=o.buildPath(t,i),u=n[i];if(u&&typeof u==="object"){o.fireChanges(e,a,u,r)}else{o.fireChange(e,a,r?undefined:u)}})},formatLiteral:function(e,t){if(e===undefined){throw new Error("Illegal value: undefined")}if(e===null){return"null"}switch(t){case"Edm.Binary":return"binary'"+e+"'";case"Edm.Boolean":case"Edm.Byte":case"Edm.Double":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":case"Edm.Single":return String(e);case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return e;case"Edm.Duration":return"duration'"+e+"'";case"Edm.String":return"'"+e.replace(p,"''")+"'";default:throw new Error("Unsupported type: "+t)}},getKeyPredicate:function(e,t,n){var r=[],i=o.getKeyProperties(e,t,n,true);if(!i){return undefined}r=Object.keys(i).map(function(e,t,n){var r=encodeURIComponent(i[e]);return n.length===1?r:encodeURIComponent(e)+"="+r});return"("+r.join(",")+")"},getKeyProperties:function(e,t,n,r){var i,a={};i=n[t].$Key.some(function(i){var u,f,s,c,l,d;if(typeof i==="string"){u=f=i}else{u=Object.keys(i)[0];f=i[u];if(!r){u=f}}s=f.split("/");d=o.drillDown(e,s);if(d===undefined){return true}c=s.pop();l=n[o.buildPath(t,s.join("/"))];d=o.formatLiteral(d,l[c].$Type);a[u]=d});return i?undefined:a},getMetaPath:function(e){return e.replace(c,"")},getPrivateAnnotation:function(e,t){var n=e["@$ui5._"];return n&&n[t]},getSelectForPath:function(e,t){if(t){t.split("/").some(function(t){if(!l.test(t)){e=e&&e.$expand&&e.$expand[t]}})}return e&&e.$select},hasPrivateAnnotation:function(e,t){var n=e["@$ui5._"];return n?t in n:false},intersectQueryOptions:function(e,n,r,i){var a=[],u={},f,s,c={};function l(e){if(r(e).getResult().$isCollection){throw new Error("Unsupported collection-valued navigation property "+e)}}function d(e,t){var n=t.split("/");return n.every(function(t,a){return a===0&&e||r(i+"/"+n.slice(0,a+1).join("/")).getResult().$kind==="Property"})}if(n.indexOf("")>=0){throw new Error("Unsupported empty navigation property path")}if(e.$select&&e.$select.indexOf("*")<0){o.addChildrenWithAncestor(n,e.$select,c);o.addChildrenWithAncestor(e.$select,n,c);s=Object.keys(c).filter(d.bind(null,true))}else{s=n.filter(d.bind(null,false))}if(e.$expand){a=Object.keys(e.$expand);a.forEach(function(a){var f,s=i+"/"+a,c={},d;o.addChildrenWithAncestor([a],n,c);if(!t(c)){l(s);u[a]=e.$expand[a];return}d=o.stripPathPrefix(a,n);if(d.length){l(s);f=o.intersectQueryOptions(e.$expand[a]||{},d,r,i+"/"+a);if(f){u[a]=f}}})}if(!s.length&&t(u)){return null}if(!s.length){s=Object.keys(u).slice(0,1)}f=Object.assign({},e,{$select:s});if(t(u)){delete f.$expand}else{f.$expand=u}return f},isSafeInteger:function(e){if(typeof e!=="number"||!isFinite(e)){return false}e=Math.abs(e);return e<=9007199254740991&&Math.floor(e)===e},makeAbsolute:function(e,t){return new n(e).absoluteTo(t).toString().replace(f,"'").replace(u,"(").replace(a,")")},namespace:function(e){var t=e.indexOf("/");if(t>=0){e=e.slice(0,t)}t=e.lastIndexOf(".");return t<0?"":e.slice(0,t)},parseLiteral:function(e,t,n){function r(r){if(!isFinite(r)){throw new Error(n+": Not a valid "+t+" literal: "+e)}return r}if(e==="null"){return null}switch(t){case"Edm.Boolean":return e==="true";case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":return r(parseInt(e));case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return e;case"Edm.Double":case"Edm.Single":return e==="INF"||e==="-INF"||e==="NaN"?e:r(parseFloat(e));default:throw new Error(n+": Unsupported type: "+t)}},publicClone:function(e){var t=o.clone(e);if(t){delete t["@$ui5._"]}return t},removeByPath:function(e,t,n){var r=e[t],i;if(r){i=r.indexOf(n);if(i>=0){if(r.length===1){delete e[t]}else{r.splice(i,1)}}}},resolveIfMatchHeader:function(e){var t=e&&e["If-Match"];if(t&&typeof t==="object"){t=t["@odata.etag"];e=Object.assign({},e);if(t===undefined){delete e["If-Match"]}else{e["If-Match"]=t}}return e},setPrivateAnnotation:function(e,t,n){var r=e["@$ui5._"];if(!r){r=e["@$ui5._"]={}}r[t]=n},stripPathPrefix:function(e,t){var n=e+"/";return t.filter(function(t){return t===e||t.startsWith(n)}).map(function(e){return e.slice(n.length)})},toArray:function(e){if(e===undefined||e===null){return[]}if(Array.isArray(e)){return e}return[e]},updateExisting:function(e,t,n,r){if(!r){return}Object.keys(n).forEach(function(i){var a=o.buildPath(t,i),u=n[i],f;if(i in r){f=r[i];if(f&&typeof f==="object"){if(Array.isArray(f)){n[i]=f}else if(u){o.updateExisting(e,a,u,f)}else{n[i]=f;o.fireChanges(e,a,f,false)}}else if(u&&typeof u==="object"){n[i]=f;o.fireChanges(e,a,u,true)}else{n[i]=f;if(u!==f){o.fireChange(e,a,f)}}}})},updateSelected:function(e,t,n,r,i){function a(t,n,r,i){var a=n.split("/");a.every(function(u,f){if(i[u]===null){r[u]=null;if(f<a.length-1){return false}o.fireChange(e,o.buildPath(t,n),r[u])}else if(typeof i[u]==="object"){r[u]=r[u]||{}}else{if(r[u]!==i[u]){r[u]=i[u];o.fireChange(e,o.buildPath(t,n),r[u])}return false}r=r[u];i=i[u];return true})}function u(e,t){Object.keys(e).forEach(function(n){var r=o.buildPath(t,n),a=e[n];if(a!==null&&typeof a==="object"){u(a,r)}else{i.push(r)}})}if(!i||i.indexOf("*")>=0){i=[];u(r)}else{i=i.concat("@odata.etag","@$ui5._/predicate")}i.forEach(function(e){a(t,e,n,r)})},updateTransientPaths:function(e,t,n){var r,i=o.buildPath(t,"-1");for(r in e){if(r.startsWith(i)){e[t+n+r.slice(i.length)]=e[r];delete e[r]}}}};return o},false);